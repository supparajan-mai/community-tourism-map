<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Community Tourism Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Analytics 4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SNFCJHF0E4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SNFCJHF0E4', { anonymize_ip: true });
  </script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html,body{margin:0;height:100%}
    #map{width:100%;height:100%}

    .topbar{
      position:absolute;top:10px;left:10px;right:10px;
      z-index:9999;
      background:rgba(255,255,255,.95);
      border-radius:12px;
      padding:8px 10px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }
    .logos img{height:32px;margin-right:6px}
    .lang .btn{border:1px solid #aaa;border-radius:20px;padding:4px 10px;font-size:12px;cursor:pointer}
    .lang .active{background:#000;color:#fff}

    .popup img{
      width:100%;
      max-height:180px;
      object-fit:cover;
      border-radius:10px;
      margin-bottom:6px;
    }
    .popup h3{margin:6px 0;font-size:16px}
    .row{font-size:13px;margin:4px 0;line-height:1.45}
    .row b{display:block;font-weight:600}

    .btns{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
    .btnlink{
      padding:6px 10px;
      border:1px solid #333;
      border-radius:8px;
      text-decoration:none;
      font-size:12px;
      color:#000;
    }
    .primary{background:#000;color:#fff}
  </style>
</head>

<body>

<div class="topbar">
  <div class="logos">
    <img src="logo-cdd.png">
    <img src="logo-surat.png">
    <img src="logo-otop.png">
  </div>

  <div class="lang">
    <span id="th" class="btn active">TH</span>
    <span id="en" class="btn">EN</span>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ================= CONFIG ================= */
const IMG_W = 2000, IMG_H = 1414;
const SHEET_ID = "1Bhs5pWubt0RZppJJ8ks1fs8Ovrh_fkENoF2W6NB77jY";
const SHEET = "places";
const URL = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET}?t=${Date.now()}`;

let LANG="th";

/* ================= MAP ================= */
const map = L.map('map',{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
const bounds=[[0,0],[IMG_H,IMG_W]];
L.imageOverlay("map.png",bounds).addTo(map);
map.fitBounds(bounds);

/* ================= HELPERS ================= */
const safe=v=>v&&String(v).trim()?v:"-";
const num=v=>Number(String(v).replace(/,/g,''))||NaN;
const t=(th,en)=>LANG==="en"?safe(en):safe(th);

function imgUrl(u){
  if(!u) return "";
  const m=u.match(/file\/d\/([^\/]+)/);
  return m?`https://drive.google.com/uc?id=${m[1]}`:u;
}

/* ================= POPUP ================= */
function popup(p){
  const lat=num(p.lat),lng=num(p.lng);
  return `
  <div class="popup">
    ${p.image_url?`<img src="${imgUrl(p.image_url)}">`:""}
    <h3>${LANG==="en"?safe(p.Community_en):safe(p.community)}</h3>

    <div class="row"><b>${LANG==="en"?"What you get":"ไปแล้วได้อะไร"}</b>${t(p.Slogan,p.Slogan_en)}</div>
    <div class="row"><b>${LANG==="en"?"Best period":"ไปช่วงไหนดีที่สุด"}</b>${t(p.Period,p.Period_en)}</div>
    <div class="row"><b>${LANG==="en"?"Preparation":"ต้องเตรียมตัวยังไง"}</b>${t(p.Preparation,p.Preparation_en)}</div>
    <div class="row"><b>${LANG==="en"?"Budget":"ใช้เงินเท่าไหร่"}</b>${t(p.Budget,p.Budget_en)}</div>
    <div class="row"><b>${LANG==="en"?"Suitable / Not":"ใครเหมาะ / ไม่เหมาะ"}</b>${t(p.For_NotFor,p.For_NotFor_en)}</div>
    <div class="row"><b>${LANG==="en"?"Facilities":"สิ่งอำนวยความสะดวก"}</b>${t(p.Facilities,p.Facilities_En)}</div>

    <div class="row"><b>${LANG==="en"?"How to go":"การเดินทาง"}</b>${t(p.how_to_go_th,p.how_to_go_en)}</div>
    <div class="row"><b>${LANG==="en"?"Contact":"ผู้ประสานงาน"}</b>${t(p.contact,p.contact_en)}</div>

    <div class="btns">
      ${Number.isFinite(lat)&&Number.isFinite(lng)?
        `<button class="btnlink primary" onclick="nav(${lat},${lng},'${p.community}')">
        ${LANG==="en"?"Navigate":"นำทาง"}</button>`:""}
      ${p.line_url?`<a class="btnlink" href="${p.line_url}" target="_blank">LINE</a>`:""}
      ${p.fb_url?`<a class="btnlink" href="${p.fb_url}" target="_blank">Facebook</a>`:""}
      ${p.tiktok_url?`<a class="btnlink" href="${p.tiktok_url}" target="_blank">TikTok</a>`:""}
      ${p.video_url?`<a class="btnlink primary" href="${p.video_url}" target="_blank">
        ${LANG==="en"?"Video":"คลิป"}</a>`:""}
    </div>
  </div>`;
}

/* ================= LOAD DATA ================= */
fetch(URL).then(r=>r.json()).then(rows=>{
  rows.forEach(p=>{
    const y=num(p.y),x=num(p.x);
    if(!Number.isFinite(y)||!Number.isFinite(x)) return;
    L.marker([y,x]).addTo(map)
      .bindPopup(()=>popup(p))
      .on("popupopen",()=>gtag('event','open_place',{place:p.community}));
  });
});

/* ================= EVENTS ================= */
function nav(lat,lng,name){
  gtag('event','click_navigate',{place:name});
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
}

document.getElementById("th").onclick=()=>{LANG="th";toggle()};
document.getElementById("en").onclick=()=>{LANG="en";toggle()};
function toggle(){
  document.getElementById("th").classList.toggle("active",LANG==="th");
  document.getElementById("en").classList.toggle("active",LANG==="en");
  map.closePopup();
}
</script>
</body>
</html>
