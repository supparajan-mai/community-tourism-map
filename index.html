<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>ปักหมุดชมวิถี | Community Tourism Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Google Analytics GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SNFCJHF0E4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-SNFCJHF0E4');
  </script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Popup */
    .popup {
      max-width: 360px;
      max-height: 70vh;          /* ⭐ สำคัญ: กัน popup เต็มจอมือถือ */
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.45;
    }

    .popup img {
      width: 100%;
      max-height: 180px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 8px;
      background: #eee;
    }

    .popup h3 {
      margin: 6px 0 8px;
      font-size: 16px;
    }

    .popup .row {
      margin: 2px 0;
    }

    .popup .row b {
      display: inline-block;
      min-width: 110px;
    }

    /* Social buttons */
    .social {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .social a {
      flex: 1;
      text-align: center;
      padding: 6px 8px;
      border-radius: 8px;
      color: #fff;
      font-size: 12px;
      text-decoration: none;
    }

    .fb { background:#1877f2; }
    .line { background:#06c755; }
    .tt { background:#000; }

    /* Footer credit */
    .credit {
      position: absolute;
      bottom: 8px;
      right: 8px;
      z-index: 999;
      background: rgba(255,255,255,0.9);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 11px;
      max-width: 92vw;
    }
  </style>
</head>

<body>

<div id="map"></div>

<div class="credit">
  แผนที่ชุมชนท่องเที่ยว OTOP นวัตวิถี จ.สุราษฎร์ธานี<br>
  พัฒนาโดย: <b>ศุภรา เจนพิชัย</b> (HiPPS19)
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/***********************
 * CONFIG
 ***********************/
const IMG_WIDTH  = 2000;
const IMG_HEIGHT = 1414;

const SPREADSHEET_ID = "1Bhs5pWubt0RZppJJ8ks1fs8Ovrh_fkENoF2W6NB77jY";
const SHEET_NAME = "places";

const SHEET_URL =
  `https://opensheet.elk.sh/${SPREADSHEET_ID}/${SHEET_NAME}?t=${Date.now()}`;

/***********************
 * MAP INIT
 ***********************/
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2,
  zoomSnap: 0.25,
  scrollWheelZoom: true
});

const bounds = [[0,0], [IMG_HEIGHT, IMG_WIDTH]];
L.imageOverlay('map.png', bounds).addTo(map);
map.fitBounds(bounds);

/***********************
 * HELPERS
 ***********************/
function safe(v) {
  if (v === null || v === undefined) return "-";
  const s = String(v).trim();
  return s ? s : "-";
}

function thaiDigitsToArabic(str) {
  const map = {'๐':'0','๑':'1','๒':'2','๓':'3','๔':'4','๕':'5','๖':'6','๗':'7','๘':'8','๙':'9'};
  return String(str).replace(/[๐-๙]/g, d => map[d]);
}

function toNumber(v) {
  if (v === null || v === undefined) return NaN;
  const s = thaiDigitsToArabic(String(v)).replace(/,/g,'').trim();
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

function normalizeImageUrl(url) {
  if (!url) return "";
  const u = String(url).trim();
  const m = u.match(/drive\.google\.com\/file\/d\/([^\/]+)\//);
  if (m && m[1]) {
    return `https://drive.google.com/uc?id=${m[1]}`;
  }
  return u;
}

/***********************
 * POPUP
 ***********************/
function popupHTML(p) {
  const imgUrl = normalizeImageUrl(p.image_url);
  const img = imgUrl ? `<img src="${imgUrl}" onerror="this.style.display='none';">` : "";

  const social = `
    <div class="social">
      ${p.fb_url ? `<a class="fb" href="${p.fb_url}" target="_blank">Facebook</a>` : ``}
      ${p.line_url ? `<a class="line" href="${p.line_url}" target="_blank">LINE</a>` : ``}
      ${p.tiktok_url ? `<a class="tt" href="${p.tiktok_url}" target="_blank">TikTok</a>` : ``}
    </div>
  `;

  return `
    <div class="popup">
      ${img}
      <h3>${safe(p.community)}</h3>

      <div class="row"><b>พื้นที่:</b> ต.${safe(p.tambon)} อ.${safe(p.amphoe)}</div>
      <div class="row"><b>วัน-เวลา:</b> ${safe(p.hours)}</div>
      <div class="row"><b>ฤดูกาลแนะนำ:</b> ${safe(p.season)}</div>
      <div class="row"><b>กิจกรรม:</b> ${safe(p.highlights)}</div>
      <div class="row"><b>สิ่งอำนวยความสะดวก:</b> ${safe(p.Facilities)}</div>
      <div class="row"><b>การเดินทาง:</b> ${safe(p.how_to_go_th)}</div>
      <div class="row"><b>ติดต่อ:</b> ${safe(p.contact)}</div>

      ${social}
    </div>
  `;
}

/***********************
 * LOAD DATA
 ***********************/
fetch(SHEET_URL)
  .then(res => res.json())
  .then(rows => {
    rows.forEach(p => {
      const y = toNumber(p.y);
      const x = toNumber(p.x);
      if (!Number.isFinite(y) || !Number.isFinite(x)) return;

      L.marker([y, x])
        .addTo(map)
        .bindPopup(popupHTML(p), {
          maxWidth: 360,
          autoPan: true,
          closeButton: true
        });
    });
  })
  .catch(err => {
    console.error(err);
    alert("ไม่สามารถโหลดข้อมูลจาก Google Sheet ได้");
  });

map.on('click', () => map.closePopup());
</script>

</body>
</html>
